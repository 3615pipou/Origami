<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="flat foldable foldability origami calculator validator svg opx fold">
<meta name="author" content="Robby Kraft">
<title>Origami Crease Pattern Validator</title>
<link href="../lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
<link href="style.css" rel="stylesheet">
<style>

.success{
	background-color: #28A745;/*#0275D8;*/
}
.fail{
	background-color: #FF2222;
}
canvas[resize]{
	width:45vmax;
	height:45vmax;
}
.half{
	display:inline-block;
	width:45vmax;
	height:45vmax;
}
#result-container{
	padding-top: 2em;
	display:none;
}
div#dropZone {
  background: black;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 999;
  opacity: 0.6;
  visibility: hidden;
}
</style>
</head>
<body>
	<div id="dropZone">
	</div>
	<div class="site-wrapper">
	  <div class="site-wrapper-inner">
		<div class="cover-container">
		  <div class="masthead clearfix">
			<div class="inner">
			  <!-- <h3 class="masthead-brand">Origami</h3> -->
			  <nav class="nav nav-masthead">
				<a class="nav-link active" href="#">Information</a>
				<a class="nav-link" href="http://github.com/robbykraft/Origami">Code</a>
			  </nav>
			</div>
			  <input type="file" id="files" style="opacity:0;">
		  </div>


		  <div class="inner cover">
			<h1 class="cover-heading">Crease Pattern Validator</h1>
			<p class="lead">Drag and drop file (.svg, <del>.opx</del>, <del>.fold</del>)</p>
			<p class="lead">
			  <a href="#" class="btn btn-lg btn-secondary" id="open-file">Open File</a>
			</p>
			<p class="lead">Flat-foldability check and simulation of folded state</p>
		  </div>
		  <div class="mastfoot">
			<div class="">
			  <p>Made by <a href="https://twitter.com/robbykraft">Robby</a></p>
			</div>
		  </div>

		</div>
	  </div>
	</div>

	<div id="result-container">
		<div class="container">
			<div id="jumbo-container" class="jumbotron success">
				<h1 id="jumbo-title">Valid</h1>
				<p id="jumbo-message">crease pattern is flat-foldable</p>
			</div>
		</div>
		<div>
			<canvas id="canvas-1" resize></canvas><canvas id="canvas-2" resize></canvas><!-- <div class="half"></div> -->
		</div>
	</div>

<script language="javascript" type="text/javascript" src="../src/graph.js"></script>
<script language="javascript" type="text/javascript" src="../src/planarGraph.js"></script>
<script language="javascript" type="text/javascript" src="../src/creasePattern.js"></script>
<script language="javascript" type="text/javascript" src="../lib/paper-full.min.js"></script>
<script language="javascript" type="text/javascript" src="../src/cp.paperjs.js"></script>

<script src="../lib/bootstrap/js/tether.min.js"></script>
<script src="../lib/jquery-3.2.1.slim.min.js"></script>
<script src="../lib/bootstrap/js/popper.min.js"></script>
<script src="../lib/bootstrap/js/bootstrap.min.js"></script>
<script src="../lib/bootstrap/js/ie10-viewport-bug-workaround.js"></script>


<script>
var project1 = new OrigamiPaper("canvas-1");
var project2 = new OrigamiPaper("canvas-2");

function svgBlobLoaded(svg){
	loadSVG(svg, function(cp){
		// project.cp = cp;
		// project.initialize();
		// project.zoomToFit();
		////////////////////////////////////////////////////////////////////////
		project1 = new OrigamiPaper("canvas-1", cp.duplicate());
		project1.colorNodesFlatFoldable = function(){
			var ffTestPassed = true;
			for(var i = 0; i < project1.cp.nodes.length; i++){
				var color = { hue:130, saturation:0.8, brightness:0.7, alpha:0.5 }
				if( !project1.cp.nodes[i].flatFoldable(0.01) ){
					ffTestPassed = false;
					color = { hue:0, saturation:0.8, brightness:1, alpha:0.5 } 
				}
				project1.nodes[i].fillColor = color;
			}
			setJumbotron(ffTestPassed);
			if(ffTestPassed){ document.getElementById("canvas-2").style.display = "inline-block"; }
			else            { document.getElementById("canvas-2").style.display = "none"; }
		}
		project1.initialize();
		project1.zoomToFit(0.05);
		project1.colorNodesFlatFoldable();
		for(var i = 0; i < project1.nodes.length; i++){ 
		// 	project1.nodes[i].radius = 0.1 * project1.cpMin;
			project1.nodes[i].visible = true;
		}

		project2 = new OrigamiPaper("canvas-2", cp.duplicate());
		project2.backgroundLayer.visible = false;
		project2.faceLayer.visible = false;
		project2.edgeLayer.visible = false;
		project2.boundaryLayer.visible = false;
		project2.nodeLayer.visible = false;

		project2.fold = function(){
			// find a face near the middle
			var centerNode = this.cp.getNearestNode(this.cp.width() * 0.5, this.cp.height()*0.5);
			if(centerNode === undefined){ return; }
			var centerFaces = centerNode.adjacentFaces();
			if(centerFaces === undefined || centerFaces.length == 0){ return; }
			var sortedFaces = centerFaces.sort(function(a,b){
				var avgA = 0;
				var avgB = 0;
				for(var i = 0; i < a.nodes.length; i++){ avgA += a.nodes[i].y; }
				avgA /= (a.nodes.length);
				for(var i = 0; i < b.nodes.length; i++){ avgB += b.nodes[i].y; }
				avgB /= (a.nodes.length);
				return (avgA < avgB) ? 1 : ((avgA > avgB) ? -1 : 0);
			});
			var centerBottomFace = sortedFaces[0];

			var answer = this.cp.adjacentFaceTree(centerBottomFace);

			var folded = [];
			this.foldedLayer = new this.scope.Layer();
			this.foldedLayer.removeChildren();
			this.foldedLayer.activate();

			for(var i = 0; i < answer.faces.length; i++){
				var face = answer.faces[i].face;
				var matrix = answer.faces[i].global;
				var segments = [];
				for(var p = 0; p < face.nodes.length; p++){
					segments.push( new XY(face.nodes[p].x, face.nodes[p].y ).transform(matrix) );
				}
				var face = new this.scope.Path({segments:segments,closed:true});
				var color = 100 + 200 * i/this.cp.faces.length;
				// face.fillColor = { hue:color, saturation:1.0, brightness:1.0, alpha:0.2 };
				face.fillColor = { gray:1.0, alpha:0.1 };
				this.faces.push( face );
			}

			// this.cp.clear();
			// this.cp.nodes = [];
			// this.cp.edges = [];


			this.cp.faces = [];
			this.style.mountain.strokeWidth = 0.0015;
			this.style.valley.strokeWidth = 0.0015;
			this.style.border.strokeWidth = 0.0015;
			this.style.mark.strokeWidth = 0.0015;
			this.initialize();
			this.backgroundLayer.visible = false;
			this.faceLayer.visible = false;
			this.edgeLayer.visible = false;
			this.boundaryLayer.visible = false;
			this.nodeLayer.visible = false;
		}
		// project2.cp = cp;
		// project2.cp = new CreasePattern().birdBase();;
		project2.cp.generateFaces();
		project2.initialize();
		project2.zoomToFit(0.05);
		project2.fold();

		showAndScrollResults();
	});
}

</script>

<!-- download svg blob -->
<!-- <script>
function download(text, filename){
	var blob = new Blob([text], {type: "image/svg+xml"});
	var url = window.URL.createObjectURL(blob);
	var a = document.createElement("a");
	a.href = url;
	a.download = filename;
	a.click();
}
</script>
 -->

<!-- drag to upload -->
<script>
var dropZone = document.getElementById('dropZone');
function showDropZone() { dropZone.style.visibility = "visible"; }
function hideDropZone() { dropZone.style.visibility = "hidden"; }
function allowDrag(e) {
	if (true) {  // Test that the item being dragged is a valid one
		e.dataTransfer.dropEffect = 'copy';
		e.preventDefault();
	}
}
function handleDrop(e) {
	Function.prototype.bindToEventHandler = function bindToEventHandler() {
		var handler = this;
		var boundParameters = Array.prototype.slice.call(arguments);
		//create closure
		return function (e) {
			e = e || window.event; // get window.event if e argument missing (in IE)   
			boundParameters.unshift(e);
			handler.apply(this, boundParameters);
		}
	};
	e.preventDefault();
	hideDropZone();
	var dt = e.dataTransfer;
	var files = dt.files;
	for (var i = 0; i < files.length; i++) {
		var file = files[i];
		var reader = new FileReader();
		//attach event handlers here...  
		reader.readAsDataURL(file);
		addEventHandler(reader, 'loadend', function (e, file) {
			var bin = this.result;
			var decoded = window.atob(this.result.substring(26));
			svgBlobLoaded(decoded);
		}.bindToEventHandler(file));
	}
	return true;
}
window.addEventListener('dragenter', function(e) { showDropZone(); });
dropZone.addEventListener('dragenter', allowDrag);
dropZone.addEventListener('dragover', allowDrag);
dropZone.addEventListener('dragleave', function(e) { hideDropZone(); });
dropZone.addEventListener('drop', handleDrop);
function addEventHandler(obj, evt, handler) {
	// w3c
	if (obj.addEventListener){ obj.addEventListener(evt, handler, false); }
	// ie
	else if (obj.attachEvent) { obj.attachEvent('on' + evt, handler); }
	// old
	else { obj['on' + evt] = handler; }
}
</script>

<!-- button to upload -->
<script>
document.getElementById("open-file").addEventListener("click", function(e){
	e.preventDefault();
	document.getElementById("files").click()
});
document.addEventListener('change', function(){
	var input = $(this),
		numFiles = input.get(0).files ? input.get(0).files.length : 1,
		label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
	input.trigger('fileselect', [numFiles, label]);
	readBlob();
}, false);
function readBlob() {
	var files = document.getElementById('files').files;
	if (!files.length) {
		// they selected cancel
		return;
	}
	var file = files[0];
	var reader = new FileReader();
	reader.onloadend = function(evt) {
		if (evt.target.readyState == FileReader.DONE){
			//byte range: ['Read ', file.size, ' byte file'].join('');
			svgBlobLoaded(evt.target.result);
		}
	};
	var blob = file.slice(0, file.size);
	reader.readAsBinaryString(blob);
}
</script>

<script>
function showAndScrollResults(){
	document.getElementById("result-container").style.display = "block";
	window.dispatchEvent(new Event('resize'));
	// $('html, body').scrollTo('#result-container');
	document.getElementById('result-container').scrollIntoView({behavior: "smooth"});	
}

function setJumbotron(success){
	var titleSuccess = "Valid";
	var titleFail = "Invalid";
	var messageSuccess = "crease pattern is flat-foldable";
	var messageFail = "crease pattern contains non-flat-foldable nodes";
	if(success){
		$("#jumbo-container").removeClass("fail");
		$("#jumbo-container").addClass("success");
		document.getElementById("jumbo-title").innerHTML = titleSuccess;
		document.getElementById("jumbo-message").innerHTML = messageSuccess;
	}
	else{
		$("#jumbo-container").removeClass("success");
		$("#jumbo-container").addClass("fail");
		document.getElementById("jumbo-title").innerHTML = titleFail;
		document.getElementById("jumbo-message").innerHTML = messageFail;
	}
}


</script>
</body>
</html>
