<!DOCTYPE html>
<html>
<head>
	<title></title>
<script src="../../lib/codemirror/lib/codemirror.js"></script>
<link rel="stylesheet" href="../../lib/codemirror/lib/codemirror.css">
<link rel="stylesheet" href="../../lib/codemirror/theme/mdn-like.css">
<script src="../../lib/codemirror/mode/javascript/javascript.js"></script>
<script type="text/javascript" src="../../lib/paper-full.min.js"></script>
<script language="javascript" type="text/javascript" src="../../creasepattern.js"></script>
<script language="javascript" type="text/javascript" src="../../src/cp.paperjs.js"></script>
<style>
body{
	display:flex;
	flex-direction: row;
}
div.column{
	flex: 1;
}
canvas[resize] {
	width: 96vmin;
	height: 96vmin;
	max-width:50vw;
	max-height:50vw;
}
</style>
</head>
<body>
<div class="column" id="codeColumn"></div>
<div class="column">
	<canvas id="canvas" resize></canvas>
</div>

<script>
var myCodeMirror = CodeMirror(document.getElementById("codeColumn"), {
	value: "",
	mode:  "javascript",
	lineNumbers: true,
	theme: "mdn-like"
}).on('change', (editor,event) => {
	// console.log( editor.getValue() );
	try{
		resetCP();
		eval(editor.getValue());
		project.draw();
	}
	catch(err){
		// console.log("broken");
	}
});

</script>

<script>
var cp = new CreasePattern();
var project = new OrigamiPaper("canvas", cp);
project.setPadding(0.05);

function resetCP(){
	project.cp.clear();
}

project.onFrame = function(event){ }
project.onResize = function(event){ }
project.onMouseMove = function(event){ }
project.onMouseDown = function(event){
	var nearestEdge = this.cp.getNearestEdge(event.point) || {};
	if(nearestEdge.edge !== undefined){
		updateCodeMirror("cp.edges[" + nearestEdge.edge.index + "]");
		// console.log( nearestEdge.edge.index );
	}
}

function updateCodeMirror(data){
	var cm = document.getElementsByClassName("CodeMirror")[0].CodeMirror;
    var doc = cm.getDoc();
    var cursor = doc.getCursor();
    var line = doc.getLine(cursor.line);
    var newline = '\n';
    if(cursor.ch == 0){ newline = ''; }
    var pos = { // create a new object to avoid mutation of the original selection
        line: (doc.size+5),
        ch: line.length - 1 // set the character position to the end of the line
    }
    doc.replaceRange(newline+data, pos);
}

</script>
</body>
</html>
